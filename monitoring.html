<!DOCTYPE html>
<html class="light" lang="id">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>Padang Sederhana - Status Pesanan</title>
    
    <!-- Libraries -->
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <link href="https://fonts.googleapis.com/css2?family=Work+Sans:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet"/>
    
    <!-- Config -->
    <script id="tailwind-config">
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#d32f2f",
                        "primary-dark": "#b71c1c",
                        "emerald": "#10b981",
                        "emerald-dark": "#047857",
                        "background-light": "#f8f9fa",
                        "text-dark": "#212121",
                        "text-muted": "#757575",
                    },
                    fontFamily: {
                        "display": ["Work Sans", "sans-serif"]
                    },
                    borderRadius: {
                        "xl": "1rem",
                        "2xl": "1.5rem",
                        "3xl": "2rem",
                    },
                    boxShadow: {
                        'soft': '0 10px 40px -10px rgba(0,0,0,0.1)',
                        'card': '0 4px 6px -1px rgba(0, 0, 0, 0.05)',
                    }
                },
            },
        }
    </script>

    <style>
        body {
            font-family: "Work Sans", sans-serif;
            background-image: radial-gradient(#e5e7eb 1px, transparent 1px);
            background-size: 24px 24px;
        }
        .custom-scroll::-webkit-scrollbar {
            width: 4px;
        }
        .custom-scroll::-webkit-scrollbar-track {
            background: transparent;
        }
        .custom-scroll::-webkit-scrollbar-thumb {
            background: #e0e0e0;
            border-radius: 10px;
        }
        .material-symbols-outlined {
            font-variation-settings: 'FILL' 0, 'wght' 500, 'GRAD' 0, 'opsz' 24;
        }
        .filled-icon {
            font-variation-settings: 'FILL' 1, 'wght' 500, 'GRAD' 0, 'opsz' 24;
        }
    </style>
</head>
<body class="bg-background-light text-text-dark min-h-screen overflow-x-hidden">

    <!-- ========================================== -->
    <!-- MOBILE VIEW (Visible < md)                 -->
    <!-- ========================================== -->
    <div class="md:hidden flex flex-col min-h-screen bg-white">
        <!-- Header -->
        <header class="pt-8 pb-4 text-center bg-white px-6">
            <div class="inline-flex items-center justify-center gap-3 mb-2">
                <div class="size-10 rounded-lg bg-primary flex items-center justify-center text-white shadow-lg shadow-primary/20">
                    <span class="material-symbols-outlined text-2xl">restaurant_menu</span>
                </div>
                <div class="text-left">
                    <h1 class="text-lg font-bold leading-none text-gray-900 tracking-tight">Restoran</h1>
                    <p class="text-primary text-sm font-bold tracking-wide">Sederhana</p>
                </div>
            </div>
        </header>

        <!-- Status Section -->
        <section class="px-6 pb-6 text-center bg-white">
            <div class="mb-8">
                <h2 class="text-3xl font-extrabold text-gray-900 leading-tight mb-3 js-status-title">
                    Memuat Status...
                </h2>
                <div class="inline-flex items-center gap-2 px-4 py-1.5 bg-yellow-50 text-yellow-700 border border-yellow-100 rounded-full text-xs font-bold uppercase tracking-wider js-status-badge">
                    <span class="material-symbols-outlined text-base filled-icon animate-spin js-status-icon">sync</span>
                    <span class="js-status-text">Memuat...</span>
                </div>
            </div>

            <!-- Queue Card -->
            <div class="bg-gray-50 rounded-2xl py-8 border border-gray-100 relative overflow-hidden group hover:shadow-md transition-shadow">
                <!-- Progress Bar Top -->
                <div class="absolute top-0 left-0 w-full h-1.5 bg-gray-200">
                    <div class="h-full bg-primary w-0 transition-all duration-1000 js-mobile-progress"></div>
                </div>
                <p class="text-xs font-bold text-gray-400 uppercase tracking-[0.2em] mb-2">Nomor Pesanan</p>
                <span class="text-8xl font-black text-orange-500 tracking-tighter leading-none block transform group-hover:scale-105 transition-transform duration-300 data-queue">---</span>
            </div>
        </section>

        <!-- Order Details -->
        <section class="flex-grow px-6 pb-24 bg-white rounded-t-3xl shadow-[0_-10px_40px_-15px_rgba(0,0,0,0.05)] border-t border-gray-50">
            <div class="flex items-center gap-2 py-6 border-b border-gray-100 mb-4 sticky top-0 bg-white z-10">
                <span class="material-symbols-outlined text-gray-400 text-lg">receipt_long</span>
                <h3 class="text-sm font-bold text-gray-500 uppercase tracking-wider">Rincian Pesanan <span class="data-order-id text-xs ml-1 font-normal opacity-50">#---</span></h3>
            </div>
            
            <div class="space-y-5 js-items-list-mobile">
                <!-- Items rendered by JS -->
            </div>
        </section>

        <!-- Sticky Footer Total -->
        <footer class="fixed bottom-0 left-0 w-full bg-primary p-6 text-white z-50 shadow-[0_-10px_40px_rgba(0,0,0,0.2)]">
            <div class="flex justify-between items-center">
                <div class="flex flex-col">
                    <span class="text-white/80 text-xs font-bold uppercase tracking-widest mb-1">Total Pembelian</span>
                    <span class="text-white/60 text-[10px] flex items-center gap-1">
                        <span class="material-symbols-outlined text-[10px]">verified_user</span>
                        Sudah termasuk pajak
                    </span>
                </div>
                <span class="text-3xl font-black tracking-tight leading-none data-grand-total">Rp 0</span>
            </div>
        </footer>
    </div>


    <!-- ========================================== -->
    <!-- DESKTOP VIEW (Visible >= md)               -->
    <!-- ========================================== -->
    <div class="hidden md:flex min-h-screen overflow-hidden">
        <!-- Main Content (Left) -->
        <section class="flex-1 flex flex-col p-8 items-center justify-center relative">
            <div class="w-full max-w-4xl flex-1 rounded-[2.5rem] bg-white flex flex-col items-center justify-center text-center p-12 shadow-floating relative border border-gray-100">
                <div class="flex flex-col items-center w-full z-10">
                    <!-- Brand Logo -->
                    <div class="inline-flex items-center justify-center gap-3 mb-8">
                        <div class="size-14 rounded-xl bg-primary flex items-center justify-center text-white shadow-lg shadow-primary/20">
                            <span class="material-symbols-outlined text-3xl">restaurant_menu</span>
                        </div>
                        <div class="text-left">
                            <h1 class="text-xl font-bold leading-none text-gray-900 tracking-tight">Restoran</h1>
                            <p class="text-primary text-base font-bold tracking-wide">Sederhana</p>
                        </div>
                    </div>
                    <h3 class="text-gray-400 text-lg font-bold tracking-[0.2em] uppercase mb-4">Nomor Pesanan Anda</h3>
                    <h1 class="text-orange-500 text-[180px] font-black leading-none mb-16 tracking-tighter drop-shadow-sm font-display select-none data-queue">
                        ---
                    </h1>
                    
                    <!-- Desktop Progress Steps -->
                    <div class="w-full max-w-2xl mt-8">
                        <div class="relative flex justify-between items-center w-full">
                            <div class="absolute left-0 top-3 w-full h-1.5 bg-gray-100 rounded-full -z-10"></div>
                            <div id="desktop-progress-bar" class="absolute left-0 top-3 w-0 h-1.5 bg-emerald rounded-full -z-10 shadow-sm shadow-emerald/30 transition-all duration-500"></div>
                            
                            <!-- Step 1 -->
                            <div id="step-diterima" class="flex flex-col items-center gap-3 group cursor-default opacity-40 grayscale transition-all duration-300">
                                <div class="size-7 rounded-full bg-emerald ring-4 ring-white shadow-md flex items-center justify-center text-white">
                                    <span class="material-symbols-outlined text-[16px] font-bold">check</span>
                                </div>
                                <span class="text-sm font-bold text-emerald uppercase tracking-wider">Diterima</span>
                            </div>
                            
                            <!-- Step 2 -->
                            <div id="step-disiapkan" class="flex flex-col items-center gap-3 group cursor-default opacity-40 grayscale transition-all duration-300">
                                <div class="size-9 rounded-full bg-emerald ring-4 ring-emerald/20 shadow-lg flex items-center justify-center relative">
                                    <span class="absolute size-full rounded-full bg-emerald animate-ping opacity-20 hidden"></span>
                                    <span class="material-symbols-outlined text-white text-[20px]">soup_kitchen</span>
                                </div>
                                <span class="text-sm font-bold text-emerald uppercase tracking-wider">Disiapkan</span>
                            </div>
                            
                            <!-- Step 3 -->
                            <div id="step-siap" class="flex flex-col items-center gap-3 group cursor-default opacity-40 grayscale transition-all duration-300">
                                <div class="size-7 rounded-full bg-gray-200 ring-4 ring-white shadow-sm flex items-center justify-center text-gray-400">
                                    <span class="material-symbols-outlined text-[16px]">shopping_bag</span>
                                </div>
                                <span class="text-sm font-bold text-gray-400 uppercase tracking-wider">Siap Diambil</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Background Icons -->
                <div class="absolute top-0 right-0 p-12 opacity-[0.03] pointer-events-none">
                    <span class="material-symbols-outlined text-9xl">restaurant</span>
                </div>
                <div class="absolute bottom-0 left-0 p-12 opacity-[0.03] pointer-events-none">
                    <span class="material-symbols-outlined text-9xl">receipt_long</span>
                </div>
            </div>
        </section>

        <!-- Sidebar (Right) -->
        <aside class="w-[400px] flex flex-col bg-white border-l border-gray-100 z-10 shadow-[-4px_0_24px_rgba(0,0,0,0.02)]">
            <!-- Sidebar Header -->
            <div class="p-6 border-b border-gray-100 flex justify-between items-end bg-gray-50/50">
                <div>
                    <h2 class="text-text-dark text-xl font-bold tracking-tight">Rincian Pesanan</h2>
                    <p class="text-gray-400 text-xs font-medium mt-1"><span class="data-type">---</span> â€¢ <span class="data-item-count">0</span> Item</p>
                </div>
                <div class="bg-white border border-gray-200 px-3 py-1 rounded-lg shadow-sm">
                    <span class="text-xs font-bold text-gray-500 data-order-id">#---</span>
                </div>
            </div>

            <!-- Items List -->
            <div class="flex-1 overflow-y-auto custom-scroll p-6 space-y-6 js-items-list-desktop">
                <!-- Items rendered by JS -->
            </div>

            <!-- Totals -->
            <div class="p-6 border-t border-gray-100 bg-gray-50/30">
                <div class="space-y-3">
                    <div class="flex justify-between text-sm font-medium">
                        <span class="text-gray-500">Subtotal</span>
                        <span class="text-text-dark data-subtotal">Rp 0</span>
                    </div>
                    <div class="flex justify-between text-sm font-medium">
                        <span class="text-gray-500">Pajak (10%)</span>
                        <span class="text-text-dark data-tax">Rp 0</span>
                    </div>
                    <div class="flex justify-between text-sm font-medium">
                        <span class="text-gray-500">Biaya Layanan</span>
                        <span class="text-text-dark data-service">Rp 0</span>
                    </div>
                </div>
            </div>

            <!-- Grand Total & Action -->
            <div class="p-6 bg-primary text-white shadow-[0_-4px_20px_rgba(0,0,0,0.1)] relative z-20">
                <div class="flex justify-between items-center">
                    <span class="text-base font-semibold text-white/90 uppercase tracking-wide">Total Pembelian</span>
                    <span class="text-3xl font-black tracking-tight data-grand-total">Rp 0</span>
                </div>
            </div>
        </aside>
    </div>

    <!-- ========================================== -->
    <!-- LOGIC SCRIPT                               -->
    <!-- ========================================== -->
    <script>
        // --- Utilities ---
        function formatIDR(number) {
            return new Intl.NumberFormat('id-ID', {
                style: 'currency',
                currency: 'IDR',
                minimumFractionDigits: 0
            }).format(number);
        }

        function setText(selector, text) {
            document.querySelectorAll(selector).forEach(el => el.innerText = text);
        }

        // --- UI Updates ---
        function updateStatusUI(status) {
            // Configuration for each status
            const config = {
                'Diterima': {
                    percent: 10,
                    mobileTitle: 'Pesanan Diterima',
                    mobileBadgeClass: 'bg-blue-50 text-blue-700 border-blue-100',
                    mobileIcon: 'receipt_long',
                    mobileIconAnim: '',
                    desktopStepId: 'step-diterima'
                },
                'Disiapkan': {
                    percent: 50,
                    mobileTitle: 'Sedang Disiapkan',
                    mobileBadgeClass: 'bg-yellow-50 text-yellow-700 border-yellow-100',
                    mobileIcon: 'sync',
                    mobileIconAnim: 'animate-spin',
                    desktopStepId: 'step-disiapkan'
                },
                'Siap': {
                    percent: 100,
                    mobileTitle: 'Siap Diambil',
                    mobileBadgeClass: 'bg-green-50 text-green-700 border-green-100',
                    mobileIcon: 'check_circle',
                    mobileIconAnim: '',
                    desktopStepId: 'step-siap'
                }
            };

            const current = config[status] || config['Diterima'];

            // 1. Update Mobile UI
            document.querySelector('.js-status-title').innerHTML = current.mobileTitle.replace(' ', '<br/>');
            
            const badge = document.querySelector('.js-status-badge');
            badge.className = `inline-flex items-center gap-2 px-4 py-1.5 border rounded-full text-xs font-bold uppercase tracking-wider js-status-badge ${current.mobileBadgeClass}`;
            
            const icon = document.querySelector('.js-status-icon');
            icon.innerText = current.mobileIcon;
            icon.className = `material-symbols-outlined text-base filled-icon js-status-icon ${current.mobileIconAnim}`;
            
            document.querySelector('.js-status-text').innerText = status;
            document.querySelector('.js-mobile-progress').style.width = `${current.percent}%`;

            // 2. Update Desktop UI
            document.getElementById('desktop-progress-bar').style.width = `${current.percent}%`;

            // Reset desktop steps
            ['step-diterima', 'step-disiapkan', 'step-siap'].forEach(id => {
                const el = document.getElementById(id);
                el.classList.add('opacity-40', 'grayscale');
                const ping = el.querySelector('.animate-ping');
                if (ping) ping.classList.add('hidden');
            });

            // Activate current desktop step
            const activeEl = document.getElementById(current.desktopStepId);
            if (activeEl) {
                activeEl.classList.remove('opacity-40', 'grayscale');
                const activePing = activeEl.querySelector('.animate-ping');
                if (activePing) activePing.classList.remove('hidden');
            }
        }

        function renderItems(items, containerSelector, isMobile = false) {
            const containers = document.querySelectorAll(containerSelector);
            containers.forEach(container => {
                container.innerHTML = ''; // Clear existing

                items.forEach(item => {
                    const el = document.createElement('div');
                    
                    // Support both old structure (item.img) and compact structure (item.m)
                    const img = item.m || item.img || item.image;
                    const encodedImg = img ? encodeURI(img) : '';
                    const name = item.n || item.name;
                    const price = item.p || item.price;
                    const qty = item.q || item.quantity;

                    if (isMobile) {
                        // Mobile Layout
                        el.className = 'flex items-start gap-4';
                        el.innerHTML = `
                            <div class="size-16 rounded-xl bg-center bg-cover shrink-0 shadow-sm border border-gray-100" style="background-image: url('${encodedImg}')"></div>
                            <div class="flex-grow min-w-0 pt-0.5">
                                <div class="flex justify-between items-start mb-1">
                                    <h4 class="font-bold text-gray-900 text-base truncate pr-2">${name}</h4>
                                    <span class="font-bold text-gray-900">${formatIDR(price * qty)}</span>
                                </div>
                                <div class="flex justify-between items-center text-xs">
                                    <p class="text-gray-500 truncate max-w-[150px]">Porsi Standar</p>
                                    <span class="font-bold text-gray-400 bg-gray-50 px-2 py-0.5 rounded">x${qty}</span>
                                </div>
                            </div>
                        `;
                    } else {
                        // Desktop Layout
                        el.className = 'flex justify-between items-start group';
                        el.innerHTML = `
                            <div class="flex gap-4">
                                <div class="size-16 rounded-xl bg-cover bg-center shrink-0 border border-gray-100 shadow-sm" style="background-image: url('${encodedImg}');"></div>
                                <div>
                                    <p class="font-bold text-text-dark text-base">${name}</p>
                                    <p class="text-[10px] text-gray-400 uppercase tracking-wide font-medium mt-0.5">Porsi Standar</p>
                                    <div class="flex items-center gap-2 mt-2">
                                        <span class="bg-gray-100 text-gray-600 text-xs font-bold px-2 py-0.5 rounded">x${qty}</span>
                                    </div>
                                </div>
                            </div>
                            <p class="font-bold text-base text-text-dark">${formatIDR(price * qty)}</p>
                        `;
                    }
                    container.appendChild(el);
                });
            });
        }

        // --- Main Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            const urlParams = new URLSearchParams(window.location.search);
            let orderData = null;

            // Support both old 'data' (encoded JSON) and new 'd' (Base64)
            const encodedData = urlParams.get('data');
            const base64Data = urlParams.get('d');

            try {
                if (base64Data) {
                    // Decode Base64 UTF-8
                    const jsonStr = decodeURIComponent(escape(atob(base64Data)));
                    const compact = JSON.parse(jsonStr);
                    
                    // Map compact keys back to original names for easier UI binding
                    orderData = {
                        id: compact.i,
                        queue: compact.q,
                        date: compact.d,
                        type: compact.t,
                        subtotal: compact.s,
                        tax: compact.x,
                        service: compact.v,
                        grandTotal: compact.g,
                        items: compact.it, // Items are already mapped in index.html
                        status: 'Diterima'
                    };
                } else if (encodedData) {
                    orderData = JSON.parse(decodeURIComponent(encodedData));
                }

                if (!orderData) {
                    console.error('No order data found in URL');
                    return;
                }
                
                // 1. Bind Text Data (works for both mobile and desktop)
                setText('.data-queue', orderData.queue);
                setText('.data-type', orderData.type);
                setText('.data-order-id', '#' + orderData.id);
                setText('.data-subtotal', formatIDR(orderData.subtotal));
                setText('.data-tax', formatIDR(orderData.tax));
                setText('.data-service', formatIDR(orderData.service));
                setText('.data-grand-total', formatIDR(orderData.grandTotal));
                setText('.data-item-count', orderData.items.length);

                // 2. Process Items (handling both flat and grouped)
                // If items already have quantities (from index.html compactData), use them
                const itemsArray = orderData.items.some(it => it.q || it.quantity) 
                    ? orderData.items 
                    : Object.values(orderData.items.reduce((acc, item) => {
                        const id = item.id || item.n; // fallback to name if no id
                        if (!acc[id]) {
                            acc[id] = { ...item, quantity: 1 };
                        } else {
                            acc[id].quantity += 1;
                        }
                        return acc;
                    }, {}));

                // 3. Render Items Lists
                renderItems(itemsArray, '.js-items-list-mobile', true);
                renderItems(itemsArray, '.js-items-list-desktop', false);

                // 4. Set Initial Status
                updateStatusUI(orderData.status || 'Diterima');

                // 5. Simulation Logic
                setTimeout(() => updateStatusUI('Disiapkan'), 5000);
                setTimeout(() => updateStatusUI('Siap'), 15000);

            } catch (e) {
                console.error('Failed to parse order data:', e);
            }
        });
    </script>
</body>
</html>
